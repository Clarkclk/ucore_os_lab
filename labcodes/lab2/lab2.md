lab2 report
====

练习1
----
实现 first-fit 连续物理内存分配算法（需要编程）

1.1 在实现first fit 内存分配算法的回收函数时，要考虑地址连续的空闲块之间的合并操作。提示:在建立空闲页块链表时，需要按照空闲页块起始地址来排序，形成一个有序的链表。可能会修改default_pmm.c中的default_init，default_init_memmap，default_alloc_pages， default_free_pages等相关函数。请仔细查看和理解default_pmm.c中的注释。

对于default_init，保留原函数，建立链表并初始化；
对于default_init_memmap，设置好每页的对应部分并加入到链表中；
对于default_alloc_pages，遍历链表，检查每个节点的property值，若大于需求空间，则将从该节点开始的需求空间大小分配出来，将剩余的空间组成一个新块，更新property值，返回分配出的需求空间的起始地址。
对于default_free_pages，遍历链表，按空间从大到小顺序插入到合适位置，并更新property值等。具体情况分为三类，可与前驱页表合并，可与后置页表合并，不能合并。前两种情况合并、删除后再插入，后一种直接找到正确位置插入。

1.2 你的first_fit算法是否有进一步的改进空间？

链表结构可以改进，算法的主要时间用在了遍历链表上，如果能将O(n)的时间复杂度减少为O(lgn)则可以大大提高算法效率。比如k-d树等。

练习2
----
实现寻找虚拟地址对应的页表项（需要编程）

2.1 简要叙述实现原理

在一级页表中查找需要的二级页表，若不存在，则分配物理内存；分配成功后进行初始化，页表项清零、创建标志位等。若分配不成功，返回报错信息。

2.2 请描述页目录项（Pag Director Entry）和页表（Page Table Entry）中每个组成部分的含义和以及对ucore而言的潜在用处

```
#define PTE_P           0x001                   // 是否已使用
#define PTE_W           0x002                   // 是否可写
#define PTE_U           0x004                   // 是否用户态使用
#define PTE_PWT         0x008                   // 是否写直达
#define PTE_PCD         0x010                   // 是否禁用cache
#define PTE_A           0x020                   // 是否被访问过
#define PTE_D           0x040                   // 脏位标志，用于write_back写回
#define PTE_PS          0x080                   // 页大小
#define PTE_MBZ         0x180                   // 保留位，全部置0
#define PTE_AVAIL       0xE00                   // 软件是否可以使用
```

潜在用处：查询时可直接找到对应页目录项的各个标志位，ucore可以借此进一步实现页机制和cache的结合，比如PTE_PWT和PTE_D。

2.3 如果ucore执行过程中访问内存，出现了页访问异常，请问硬件要做哪些事情？

首先要通过CR0~CR3寄存器保存现场，设置相应位;然后跳转到该中断服务例程异常处理入口，之后交给操作系统；异常处理完成后恢复线程，继续刚才的指令向下运行。

练习3
----
释放某虚地址所在的页并取消对应二级页表项的映射

首先判断要移除的页是否存在，若存在则找到其映射项，减少其被应用的次数，将标志值减1,当引用次数变为0时，就释放该页。

3.1 数据结构Page的全局变量（其实是一个数组）的每一项与页表中的页目录项和页表项有无对应关系？如果有，其对应关系是啥？

有，page的全局变量表示物理内存中的页，即页表和页目录项中的表项指示的物理地址页。

3.2 如果希望虚拟地址与物理地址相等，则需要如何修改lab2，完成此事？ 鼓励通过编程来具体完成这个问题

需要将ucore的起始地址和kernel虚地址设为相同的值，即等同于lab1的情形。

总结：
实验代码主要参考答案中的实现。
重要知识点：最先匹配算法，虚拟地址和物理地址的映射，多级页表的管理等。
未涉及知识点：最佳匹配和最差匹配，伙伴系统等。





